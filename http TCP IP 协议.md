[toc]


---


原文：
https://www.cnblogs.com/jking10/p/5525519.html
不公开

# 1、TCP 协议
TCP(Transmission Control Protocol) 传输控制协议。
TCP是主机对主机层的传输控制协议，提供可靠的连接服务，采用==三次==握手确认建立一个连接。

## 位码 (tcp标志位)
即tcp标志位，有6种标示:
- **==SYN==** (synchronous建立联机) 
- **==ACK==** (acknowledgement 确认) 
- **PSH** (push传送) 
- **==FIN==** (finish结束) 
- **RST** (reset重置) 
- **URG** (urgent紧急)

<br>

- Sequence number(顺序号码) 
- Acknowledge number(确认号码)。

**==手机能够使用联网功能是因为手机底层实现了TCP/IP协议，可以使手机终端通过无线网络建立TCP连接。==**
TCP协议可以对上层网络提供接口，使上层网络数据的传输建立在" ==**无差别**== "的网络之上。


## 连接：三次握手
<u>建立起一个TCP连接需要经过“三次握手”</u>
涉及到的包： SYN (连接)， ACK (确认)

**第一次握手**
- ==客户端发送 SYN 包(syn=j)到服务器==，并进入 **SYN_SEND** 状态，
- 等待服务器确认；

**第二次握手**
- ==服务器==收到 SYN 包，
- 必须确认客户的SYN（ack=j+1），同时自己也==发送一个SYN包==（syn=k），即 SYN+ACK 包，
- 此时服务器进入 **SYN_RECV** 状态；

**第三次握手**
- ==客户端==收到服务器的 SYN＋ACK 包，
- ==向服务器发送确认包 ACK (ack=k+1)==，此包发送完毕，
- 客户端和服务器进入 **ESTABLISHED** 状态，完成三次握手。


## 实例
TCP的作用是**流量控制**，主要是**控制数据流的传输**。

下面以浏览网页为例，根据自身理解来解释一下这个过程。（注：第二个ack属于代码段ack位）
pc 浏览服务器网页此过程不包括域名查询，只描述 TCP 与 http 数据流的变化。
pc 与 http 服务器进行三次握手来建立连接。

动画：
https://blog.csdn.net/bntX2jSQfEHy7/article/details/80837422

### 1) 三次握手：建立 TCP 连接

```py
1. PC --> seq=0, ack=0, syn=1, ack=0 --> server  # SYN 建立同步TCP连接请求
2. PC <-- seq=0, ack=1, syn=1, ack=1 <-- server  # SYN+ACK 同步响应 并确定是否连接
3. PC --> seq=1, ack=1, syn=0, ack=1 --> server  # SEQ+ACK 结果确定, 正式连接
```

握手过程中传送的包里不包含数据，**三次握手完毕后，客户端与服务器才正式开始传送数据**。



### 2) 握手成功后开始传输数据
1. pc :  产生 http 数据消息，向服务器发送 get 请求.
2. server : 收到请求并发送 **==TCP 确认==**，然后发送 http 数据信息给客户端的浏览器.
3. pc :  收到服务器的 http 信息，然后发送 TCP 确认信息给服务器.
```py
1.  PC --> 请求data --> server     # 请求数据 data

2.  PC <--   ACK   <-- server     # 响应, 告诉 PC 收到请求了
3.  PC <--   data  <-- server     # 返回数据 data

4.  PC -->   ACK   --> server     # 确定, 告诉 server 收到 data 了
```

理想状态下，<u>TCP连接一旦建立，在通信双方中的任何一方主动关闭连接之前，TCP 连接都将被一直保持下去</u>。

### 3) 四次挥手：关闭 TCP 连接
<u>断开连接时服务器和客户端均可以主动发起断开TCP连接的请求</u>，断开过程需要经过“四次挥手”。
**FIN**：结束，**ACK**：确认
```py
1.  PC --> FIN + ACK --> server     # 请求关闭 TCP 连接

2.  PC <-- ACK       <-- server     # 响应, 告诉 PC 收到关闭请求了
3.  PC <-- FIN + ACK <-- server     # 关闭 TCP 连接

4.  PC --> ACK       --> server     # 确定, 告诉 server 收到, 整个会话结束
```
## 实例2
```py
# 第一次握手： 192.168.1.116 发送位码 syn 1, 随机产生 seq number=3626544836 的数据包到 192.168.1.123,
# 192.168.1.123 由 SYN=1 知道 192.168.1.116 要求建立联机 ;
IP 192.168.1.116 > 192.168.1.123: S 3626544836:3626544836

# 第二次握手： 192.168.1.123 收到请求后要确认联机信息，向 192.168.1.116 发送 ack number=3626544837,syn=1,ack=1, 随机产生 seq=1739326486 的包 ; 
IP 192.168.1.123 > 192.168.1.116: S 1739326486:1739326486 ack 3626544837

# # 第三次握手： 192.168.1.116 收到后检查 ack number 是否正确，即第一次发送的 seq number+1, 以及位码 ack 是否为 1 ，若正确， 192.168.1.116 会再发送 ack number=1739326487,ack=1 ， 192.168.1.123 收到后确认 seq=seq+1,ack=1 则连接建立成功。
IP 192.168.1.116 > 192.168.1.123: ack 1739326487,ack 1
```

# 2、HTTP 协议

**HTTP协议即超文本传送协议(Hypertext Transfer Protocol)**。
是Web联网的基础，也是手机联网常用的协议之一，<br>HTTP协议是建立在TCP协议之上的一种应用。


HTTP连接最显著的特点是
**客户端发送的每次请求都需要服务器回送响应**，在请求结束后，会主动释放连接。<br>从建立连接到关闭连接的过程称为“一次连接”。

## 一次连接
1. 在HTTP 1.0中，客户端的每次请求都要求建立一次单独的连接，在处理完本次请求后，就自动释放连接。
2. 在HTTP 1.1中则可以在一次连接中处理多个请求，并且多个请求可以重叠进行，不需要等待一个请求结束后再发送下一个请求。

## 无状态 短连接
- **由于HTTP在每次请求结束后都会主动释放连接**，
HTTP 连接是一种 " ==短连接=="，要保持客户端程序的在线状态，
需要不断地向服务器发起连接请求。<br>
通常的做法是即时不需要获得任何数据，客户端也保持每隔一段固定的时间向服务器发送一次“保持连接”的请求，服务器在收到该请求后对客户端进行回复，表明知道 客户端“**在线**”。<br>若服务器长时间无法收到客户端的请求，则认为客户端“**下线**”，<br>若客户端长时间无法收到服务器的回复，则认为**网络已经断开**。<br><br>

- **http协议是==无状态==的**。
同一个客户端的这次请求和上次请求是没有对应关系，
对http服务器来说，它并不知道这两个请求来自同一个客户端。 
为了解决这个问题， Web程序引入了 **Cookie** 机制来维护状态.

## 状态码
Response 消息中的第一行叫做状态行，
由HTTP协议版本号， 状态码， 状态消息 三部分组成。

状态码用来告诉HTTP客户端,HTTP服务器是否产生了预期的Response.

HTTP/1.1中定义了5类状态码， 状态码由三位数字组成，第一个数字定义了响应的类别

- **1XX**  提示信息
表示请求已被成功接收，继续处理<br><br>

- **2XX**  成功
表示请求已被成功接收，理解，接受<br><br>
- **3XX**  重定向
要完成请求必须进行更进一步的处理<br><br>
- **4XX**  客户端错误 
请求有语法错误或请求无法实现<br><br>
- **5XX**  服务器端错误  
服务器未能实现合法的请求

# 3、SOCKET (一对套接字)

## 3.1 套接字(socket)概念

套接字(socket) 是通信的基石，是支持TCP/IP协议的网络通信的基本操作单元。

它是网络通信过程中端点的抽象表示，
包含进行网络通信必须的五种信息：
- 连接使用的协议，
- 本地主机的 IP 地址，
- 本地进程的协议端口，
- 远地主机的 IP 地址，
- 远地进程的协议口。

应用层通过传输层进行数据通信时，TCP会遇到同时为多个应用程序进程提供并发服务的问题。多个TCP连接或多个应用程序进程可能需要通过同一个 TCP协议端口传输数据。为了区别不同的应用程序进程和连接，许多计算机操作系统为应用程序与TCP／IP协议交互提供了套接字(Socket)接口。应用层可以和传输层通过Socket接口，区分来自不同应用程序进程或网络连接的通信，实现数据传输的并发服务。


## 3.2 建立socket连接
### 建立Socket连接至少需要一对套接字
- 一个运行于**客户端**，称为 **ClientSocket** ，
- 另一个运行于**服务器端**，称为 **ServerSocket** 。


### 套接字之间的连接过程分为三个步骤

#### 服务器 监听
服务器端套接字并不定位具体的客户端套接字，而是处于等待连接的状态，实时监控网络状态，等待客户端的连接请求。

#### 客户端 请求
指客户端的套接字提出连接请求，要连接的目标是服务器端的套接字。
为此，客户端的套接字必须首先描述它要连接的服务器的套接字，指出服务器端套接字的地址和端口号，然后就向服务器端套接字提出连接请求。

#### 连接确认
- 当服务器端套接字监听到或者说接收到客户端套接字的连接请求时，就响应客户端套接字的请求，建立一个新的线程，把服务器端套接字的描述发 给客户端，一旦客户端确认了此描述，双方就正式建立连接。
- 而服务器端套接字继续处于监听状态，继续接收其他客户端套接字的连接请求。


## 3.3、SOCKET 连接与 TCP 连接

创建Socket连接时，可以指定使用的传输层协议，Socket可以支持不同的传输层协议（TCP或UDP），当使用TCP协议进行连接时，该Socket连接就是一个TCP连接。


## 3.4、Socket 连接与 HTTP 连接

由于==通常情况下Socket连接就是TCP连接==，因此Socket连接一旦建立，通信双方即可开始相互发送数据内容，直到双方连接断开。
但在实际网络应用中，客户端到服务器之间的通信往往需要穿越多个中间节点，例如路由器、网关、防火墙等，
大部分防火墙默认会关闭长时间处于非活跃状态的连接而导致 Socket 连接断连，因此需要通过轮询告诉网络，该连接处于活跃状态。
而HTTP连接使用的是“请求—响应”的方式，不仅在请求时需要先建立连接，而且需要客户端向服务器发出请求后，服务器端才能回复数据。

很多情况下，需要服务器端主动向客户端推送数据，保持客户端与服务器数据的实时与同步。
此时若双方建立的是Socket连接，服务器就可以直接将数据传送给客户端；
若双方建立的是HTTP连接，则服务器需要等到客户端发送一次请求后才能将数据传回给客户端，因此，客户端定时向服务器端发送连接请求，不仅可以保持在线，同时也是在“询问”服务器是否有新的数据，如果有就将数据传给客户端。

# 4、IP协议

IP 是英文 **Internet Protocol**（网络之间互连的协议）的缩写，
中文简称为“网协”，也就是为计算机网络相互连接进行通信而设计的协议。

在因特网中，它是能使连接到网上的所有计算机网络实现相互通信的一套规则，规定了计算机在因特网上进行通信时应当遵守的规则。
**任何厂家生产的计算机系统，只要遵守 IP协议就可以与因特网互连互通**。

另外，IP还有进入防护，知识产权，指针寄存器等含义。

IP 是怎样实现网络互连设备，如以太网、分组交换网等，它们相互之间不能互通，不能互通的主要原因是因为它们所传送数据的基本单元（技术上称之为“帧”）的格式不同。

## IP协议
- IP协议 实际上是一套由软件、程序组成的协议软件，它把各种不同“帧”统一转换成“IP数据包”格式，这种转换是因特网的一个最重要的特点，使所有各种计算机都能在因特网上实现互通，即具有“==开放性==”的特点。
- IP协议 中还有一个非常重要的内容，那就是给因特网上的每台计算机和其它设备都规定了一个唯一的地址，叫做“IP 地址”。

## IP地址
由于有这种唯一的地址，才保证了用户在连网的计算机上操作时，能够高效而且方便地从千千万万台计算机中选出自己所需的对象来。<br>
如今电信网正在与 IP网走向融合，以IP为基础的新技术是热门的技术，如用IP网络传送话音的技术（即VoIP）就很热门，其它如IP overATM、IPoverSDH、IP over WDM等等，都是IP技术的研究重点。